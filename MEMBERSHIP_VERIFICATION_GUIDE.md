# ðŸ“± Membership Card Verification URL Guide
**Nightingales of Kuwait - QR Code & Verification System**

---

## ðŸ” Verification URLs Overview

The system provides **multiple URLs** for membership verification:

### 1ï¸âƒ£ **Primary URL (Recommended)**
```
http://127.0.0.1:8000/verify-membership
```
- **Purpose:** Main public verification page
- **Method:** GET (show form) / POST (verify)
- **Features:** 
  - Search by Civil ID or NOK ID
  - Optional email verification
  - Rate limited (10 requests per minute)
  - Shows member status (Active/Expired/Pending)

---

### 2ï¸âƒ£ **Short URL (Used in QR Codes)**
```
http://127.0.0.1:8000/verify
```
- **Purpose:** Shorter URL for QR codes
- **Same functionality** as primary URL
- **Auto-prefills** Civil ID from query parameter

---

### 3ï¸âƒ£ **Public Alias URL**
```
http://127.0.0.1:8000/public/verify
```
- **Purpose:** Alternative public URL
- **Same functionality** as other verify URLs
- **Used by:** Some QR code generators

---

## ðŸ“² QR Code Format

### Current QR Code URL:
```
http://127.0.0.1:8000/verify?civil_id={CIVIL_ID}
```

**Example:**
```
http://127.0.0.1:8000/verify?civil_id=123459999999
```

### QR Code Specifications:
- **Format:** SVG (Scalable Vector Graphics)
- **Size:** 300x300 pixels
- **Storage:** `storage/app/public/members/qrcodes/qr_{id}.svg`
- **Public Access:** `http://127.0.0.1:8000/storage/members/qrcodes/qr_1.svg`
- **Generated:** Automatically on member approval/renewal

---

## ðŸŽ¯ How Verification Works

### Step 1: User Scans QR Code
QR code on membership card contains URL:
```
http://127.0.0.1:8000/verify?civil_id=123459999999
```

### Step 2: Page Opens with Prefilled Civil ID
- Form automatically fills in Civil ID from URL
- User can optionally add email for double verification
- Click "Verify Membership" button

### Step 3: System Searches Database
```php
// Searches both civil_id AND nok_id columns
WHERE (civil_id = '123459999999' OR nok_id = '123459999999')
```

### Step 4: Display Results

#### âœ… **Active Member:**
Shows:
- âœ… Green "Membership Verified â€” Active Member" banner
- Member name, NOK ID, email
- Card issued date & expiry date
- QR code image
- "Download PDF" button
- "Active Member" badge

#### âš ï¸ **Expired Member:**
Shows:
- ðŸŸ¡ Yellow "Membership Status â€” Expired" banner
- Member details
- Expiry date (in the past)
- "Expired" badge
- Message to renew membership

#### âŒ **Not Found:**
Shows:
- ðŸ”´ Red error message
- "No member found with this Civil ID or NOK ID"
- Suggestion to contact admin

---

## ðŸ” Security Features

### Rate Limiting:
```php
->middleware('throttle:10,1') // 10 requests per minute
```
- Prevents abuse/brute force
- Returns 429 error if exceeded

### Validation:
- Civil ID: Required, max 50 characters
- Email: Optional, must be valid email format
- CSRF token required for POST requests

### Search Logic:
```php
// User-friendly: searches both ID types
WHERE (civil_id = 'INPUT' OR nok_id = 'INPUT')
```
This handles cases where users confuse Civil ID with NOK ID.

---

## ðŸ“ Where Verification URLs Are Used

### 1. **QR Codes on Membership Cards**
- Embedded in PDF: `resources/views/membership_card.blade.php`
- Generated by: `RegistrationsTable.php` (on approval)
- URL format: `verify?civil_id={civil_id}`

### 2. **Email Links**
- In membership card emails: `emails/membership/card.blade.php`
- Direct verification link for recipients

### 3. **Public Website**
- Accessible from main navigation (optional)
- No login required
- Public service for verification

---

## ðŸ› ï¸ Technical Implementation

### Route Definition:
```php
// routes/web.php

// Main verification routes
Route::get('/verify-membership', [VerificationController::class, 'showForm'])
    ->name('verify-member.form');

Route::post('/verify-membership', [VerificationController::class, 'verify'])
    ->middleware('throttle:10,1')
    ->name('verify-member.post');

// Friendly aliases
Route::get('/verify', [VerificationController::class, 'showForm'])
    ->name('verify');

Route::get('/public/verify', [VerificationController::class, 'showForm'])
    ->name('public.verify');
```

### Controller Methods:
```php
// app/Http/Controllers/VerificationController.php

public function showForm(Request $request)
{
    // Supports ?civil_id= or ?nok_id= in URL
    $prefillCivilId = $request->query('civil_id') ?? $request->query('nok_id');
    
    return view('verify-membership', [
        'prefillCivilId' => $prefillCivilId,
    ]);
}

public function verify(Request $request)
{
    // Validates and searches database
    // Returns view with member data or error
}
```

### QR Code Generation:
```php
// app/Filament/Resources/Registrations/Tables/RegistrationsTable.php

use SimpleSoftwareIO\QrCode\Facades\QrCode;
use Illuminate\Support\Facades\Storage;

// Generate QR code
$verifyUrl = route('public.verify', ['civil_id' => $record->civil_id]);
$qrSvg = QrCode::format('svg')->size(300)->generate($verifyUrl);
$qrPath = 'members/qrcodes/qr_'.$record->id.'.svg';
Storage::disk('public')->put($qrPath, $qrSvg);
$record->qr_code_path = $qrPath;
$record->save();
```

---

## ðŸ§ª Testing Verification URLs

### Test 1: Direct URL Access
```bash
# Open in browser:
http://127.0.0.1:8000/verify-membership
```
Should show: Empty verification form

### Test 2: Prefilled URL (from QR code)
```bash
# Open in browser:
http://127.0.0.1:8000/verify?civil_id=123459999999
```
Should show: Form with Civil ID already filled

### Test 3: Submit Verification
1. Enter Civil ID: `123459999999`
2. Click "Verify Membership"
3. Should see: Member details with green "Active" badge

### Test 4: QR Code Image Access
```bash
# Open in browser:
http://127.0.0.1:8000/storage/members/qrcodes/qr_1.svg
```
Should show: QR code SVG image

### Test 5: Scan QR Code
1. Use phone's camera or QR scanner app
2. Scan QR code on membership card PDF
3. Should open: Verification page with prefilled Civil ID
4. Should show: Member details automatically

---

## ðŸ”„ Update QR Code URL (if needed)

### For Production Domain:

1. **Update QR Generation Code:**
```php
// In RegistrationsTable.php, change:
$verifyUrl = route('public.verify', ['civil_id' => $record->civil_id]);

// Or use full URL:
$verifyUrl = 'https://nokkw.org/verify?civil_id=' . $record->civil_id;
```

2. **Regenerate QR Codes:**
```bash
php artisan tinker
```
```php
// Regenerate for all approved members
$members = App\Models\Registration::where('renewal_status', 'approved')->get();
foreach ($members as $member) {
    $verifyUrl = route('public.verify', ['civil_id' => $member->civil_id]);
    $qrSvg = \SimpleSoftwareIO\QrCode\Facades\QrCode::format('svg')->size(300)->generate($verifyUrl);
    $qrPath = 'members/qrcodes/qr_'.$member->id.'.svg';
    \Illuminate\Support\Facades\Storage::disk('public')->put($qrPath, $qrSvg);
    $member->qr_code_path = $qrPath;
    $member->save();
    echo "Updated QR for: {$member->memberName}\n";
}
```

---

## ðŸ“± Mobile-Friendly Features

### Responsive Design:
- âœ… Works on all screen sizes
- âœ… Touch-friendly buttons
- âœ… Large, readable text
- âœ… Optimized for phone cameras

### QR Code Best Practices:
- Size: 300x300 minimum (scales well)
- Format: SVG (works at any resolution)
- Error correction: Medium level
- Quiet zone: Automatic padding

---

## ðŸŒ Production URL Configuration

### When going live, update these files:

#### 1. Environment File (`.env`)
```env
APP_URL=https://nokkw.org
```

#### 2. QR Code Generation
Will automatically use `APP_URL` when using `route()` helper:
```php
$verifyUrl = route('public.verify', ['civil_id' => $record->civil_id]);
// Becomes: https://nokkw.org/verify?civil_id=123459999999
```

#### 3. Clear Config Cache
```bash
php artisan config:clear
php artisan route:clear
php artisan cache:clear
```

---

## ðŸ“Š Verification URL Examples

### Development:
```
http://127.0.0.1:8000/verify?civil_id=123459999999
http://127.0.0.1:8000/verify?nok_id=NOK001002
http://127.0.0.1:8000/verify-membership
```

### Production:
```
https://nokkw.org/verify?civil_id=123459999999
https://nokkw.org/verify?nok_id=NOK001002
https://nokkw.org/verify-membership
```

### Direct QR Code Image:
```
http://127.0.0.1:8000/storage/members/qrcodes/qr_1.svg
https://nokkw.org/storage/members/qrcodes/qr_1.svg
```

---

## ðŸŽ¯ URL Parameters Reference

| Parameter | Type | Required | Example | Description |
|-----------|------|----------|---------|-------------|
| `civil_id` | string | Optional | `123459999999` | Pre-fills Civil ID field |
| `nok_id` | string | Optional | `NOK001002` | Pre-fills with NOK ID |
| `email` | string | Optional | `member@example.com` | For double verification |

**Usage:**
```
/verify?civil_id=123459999999
/verify?nok_id=NOK001002
/verify?civil_id=123459999999&email=member@example.com
```

---

## ðŸ” Verification Flow Diagram

```
[Member Card with QR Code]
        â†“ (Scan)
[Mobile Phone Camera]
        â†“
[Opens: /verify?civil_id=123459999999]
        â†“
[Verification Form (Pre-filled)]
        â†“ (Click Verify)
[POST to /verify-membership]
        â†“
[Database Search: civil_id OR nok_id]
        â†“
    â”Œâ”€â”€â”€â”´â”€â”€â”€â”
    â†“       â†“
[Found]  [Not Found]
    â†“       â†“
[Display Details] [Show Error]
```

---

## ðŸ“‹ Checklist for QR Code Setup

- [x] QR code library installed (`simplesoftwareio/simple-qrcode`)
- [x] Storage symlink created (`php artisan storage:link`)
- [x] QR codes generated on approval
- [x] Verification routes configured
- [x] Rate limiting enabled
- [x] Mobile-responsive design
- [x] SVG format for scalability
- [x] Civil ID and NOK ID search
- [x] Error handling implemented
- [ ] Production domain configured (when ready)
- [ ] SSL certificate for HTTPS (when live)

---

## ðŸš€ Quick Commands

### Generate QR for Specific Member:
```bash
php artisan tinker
```
```php
$member = App\Models\Registration::find(1);
$url = route('public.verify', ['civil_id' => $member->civil_id]);
$qr = \SimpleSoftwareIO\QrCode\Facades\QrCode::format('svg')->size(300)->generate($url);
\Illuminate\Support\Facades\Storage::disk('public')->put('members/qrcodes/qr_'.$member->id.'.svg', $qr);
$member->qr_code_path = 'members/qrcodes/qr_'.$member->id.'.svg';
$member->save();
```

### Test Verification:
```bash
# Open browser to:
http://127.0.0.1:8000/verify?civil_id=123459999999
```

### View All Routes:
```bash
php artisan route:list --name=verify
```

---

## ðŸ“ž Support

**Current URLs (Development):**
- Verification Form: http://127.0.0.1:8000/verify-membership
- Short URL: http://127.0.0.1:8000/verify
- Public URL: http://127.0.0.1:8000/public/verify

**QR Code Format:**
```
http://127.0.0.1:8000/verify?civil_id={CIVIL_ID}
```

**All URLs working:** âœ… Tested and verified!

---

**Last Updated:** October 24, 2025  
**Status:** âœ… Fully Operational  
**QR Codes:** Working with SVG format










